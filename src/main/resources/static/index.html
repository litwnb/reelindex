<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Movies</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<nav class="bg-gray-800 p-4 text-white flex justify-between items-center">
    <div class="flex items-center gap-6">
        <h1 class="font-bold text-2xl">Reelindex</h1>
        <a href="/movies" class="hover:underline">Movies</a>
        <a href="/ratings" class="hover:underline">My Ratings</a>
        <a href="/watchlist" class="hover:underline">Watchlist</a>
    </div>
    <div class="flex gap-6">
        <a href="/register" class="hover:underline">Register</a>
        <a href="/user" class="hover:underline">Profile</a>
        <a href="/change-password" class="hover:underline">Change Password</a>
        <a href="/logout" class="hover:underline text-red-500">Logout</a>
    </div>
</nav>
<div class="max-w-5xl mx-auto py-8">
    <h1 class="text-3xl font-bold mb-6">Movies</h1>

    <!-- Filters -->
    <form id="filterForm" class="mb-6 flex flex-wrap gap-4 items-end">
        <div>
            <label for="title" class="block mb-1 font-semibold">Title</label>
            <input type="text" id="title" name="title" placeholder="Title" class="border p-2 rounded" />
        </div>
        <div>
            <label for="director" class="block mb-1 font-semibold">Director</label>
            <input type="text" id="director" name="director" placeholder="Director" class="border p-2 rounded" />
        </div>
        <div>
            <label for="genre" class="block mb-1 font-semibold">Genre</label>
            <select id="genre" name="genre" class="border p-2 rounded">
                <option value="">Any</option>
                <option value="ACTION">Action</option>
                <option value="ADVENTURE">Adventure</option>
                <option value="BIOGRAPHY">Biography</option>
                <option value="COMEDY">Comedy</option>
                <option value="CRIME">Crime</option>
                <option value="DRAMA">Drama</option>
                <option value="FAMILY">Family</option>
                <option value="FANTASY">Fantasy</option>
                <option value="HISTORY">History</option>
                <option value="HORROR">Horror</option>
                <option value="MUSIC">Music</option>
                <option value="MYSTERY">Mystery</option>
                <option value="NOIR">Noir</option>
                <option value="ROMANCE">Romance</option>
                <option value="SCI_FI">Science fiction</option>
                <option value="SPORT">Sport</option>
                <option value="THRILLER">Thriller</option>
                <option value="WAR">War</option>
                <option value="WESTERN">Western</option>
            </select>
        </div>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Filter</button>
    </form>

    <div id="moviesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div class="flex justify-center items-center gap-4 mt-8">
        <button id="prevBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50" disabled>Previous</button>
        <span>Page <span id="currentPage">1</span> of <span id="totalPages">?</span></span>
        <button id="nextBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded disabled:opacity-50" disabled>Next</button>
    </div>
</div>

<script>
    let currentPage = 0;
    const moviesPerPage = 12;
    let currentFilters = {
        title: '',
        director: '',
        genre: ''
    };

    async function loadMovies(page = 0) {
        const params = new URLSearchParams({
            pageNumber: page,
            moviesPerPage,
            ...currentFilters
        });

        for (const key of Object.keys(currentFilters)) {
            if (!currentFilters[key])
                params.delete(key);
        }

        const res = await fetch(`/api/movies?${params.toString()}`);
        if (!res.ok) {
            document.getElementById('moviesList').textContent = 'Failed to load movies.';
            return;
        }
        const data = await res.json();
        const container = document.getElementById('moviesList');
        container.innerHTML = '';

        (data.content || data).forEach(movie => {
            const el = document.createElement('div');
            el.className = 'bg-white rounded shadow p-4 cursor-pointer hover:shadow-lg';
            el.innerHTML = `
            <h2 class="text-xl font-semibold mb-2">${movie.title}</h2>
            <p class="text-gray-600">${movie.releaseYear} â€¢ ${movie.genre}</p>
            <p class="mt-2 text-sm text-gray-700">${movie.overview ? movie.overview.substring(0, 100) + '...' : ''}</p>
        `;
            el.onclick = () => {
                window.location.href = '/movie?id=' + movie.id;
            };
            container.appendChild(el);
        });

        currentPage = data.pageable.pageNumber;
        const totalPages = data.totalPages;

        document.getElementById('currentPage').textContent = currentPage + 1;
        document.getElementById('totalPages').textContent = totalPages;

        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = currentPage + 1 >= totalPages;
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 0) loadMovies(currentPage - 1);
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        loadMovies(currentPage + 1);
    });

    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        currentFilters = {
            title: formData.get('title').trim(),
            director: formData.get('director').trim(),
            genre: formData.get('genre')
        };
        loadMovies(0);
    });

    loadMovies();
</script>
</body>
</html>
